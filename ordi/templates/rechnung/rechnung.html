
{% extends 'base.html' %}


{% block title %}
  Rechnung
{% endblock %}


{% block content %}
  <div>
    <div class="row-grid" style="grid-template-columns: auto auto;">
      {% if rechnung and rechnung.id %}
        {% with person=rechnung.person %}
          {% include 'patient/_person.html' %}
        {% endwith %}

        {% with tier=rechnung.tier %}
          {% include 'patient/_tier.html' %}
        {% endwith %}
      {% else %}
          {% include 'patient/_person.html' %}
          {% include 'patient/_tier.html' %}
      {% endif %}      
    </div>
  </div>

    <div class="gap"></div>

  {% if rechnung and rechnung.id %}
    <form method="post" action="{{ url_for('rechnung.edit', rechnung_id=rechnung.id) }}">
  {% else %}
    <form method="post" action="{{ url_for('rechnung.create', id=id) }}">
  {% endif %}
        <input type="hidden" name="rechnung_id" id="rechnung_id" value="{{- rechnung.id or '' -}}">
      <div>
        <div class="row-grid" style="grid-template-columns: auto auto auto auto;">
            <label for="jahr">Rechnungsjahr</label>
            <input type="text" size=3 name="jahr" id="jahr" class="change" value="{{- request.form['jahr'] or rechnung.jahr|sn -}}" required>

            <label for="lfnr">Rechnungslfnr</label>
            <input type="text" size=3 name="lfnr" id="lfnr" class="change" value="{{- request.form['lfnr'] or rechnung.lfnr|sn -}}" required>

            <label for="datum">Ausstellungsdatum</label>
            <input type="text" size=8 name="datum" id="datum" class="date change" value="{{- request.form['datum'] or rechnung.datum|dt or datum -}}" required>

            <label for="ort">Ausstellungsort</label>
            <input type="text" size=10 name="ort" id="ort" class="change" value="{{- request.form['ort'] or rechnung.ort or ort -}}" required>
        </div>
      </div>
      <div>
        <div class="row-grid" style="grid-template-columns: auto auto;">
            <label for="diagnose">Diagnose</label>
            <textarea style="width: 480px; height: 42px" name="diagnose" id="diagnose" class="change">{{- request.form['diagnose'] or rechnung.diagnose|sn -}}</textarea>

            <label for="bezahlung">Bezahlung</label>
            <input type="text" size=30 name="bezahlung" id="bezahlung" class="change" value="{{- request.form['bezahlung'] or rechnung.bezahlung|sn -}}">
        </div>
      <div>

      <div class="gap"></div>

      <table class="liste">
        <thead>
            <tr>
                <th style="width: 10%">Datum</th>
                <th style="width: 19.8%">Artikelart</th>
                <th style="width: 53.6">Detail</th>
                <th style="width: 9.6%">Betrag</th>
                <th style="width: 7%">&nbsp;</th>
            </tr>
        </thead>
      </table>

      <div id="scroller" style="max-height: 25vh; overflow-y: scroll; overflow-x: hidden;">
        <table class="liste">
            <tbody>
              {% for rz in rechnungszeilen %}
                <tr>
                  <td style="width: 10%">
                  {% if rz.id %}
                    <input type="hidden" name="rechnungszeile_id[]" value="{{- rz.id -}}">
                    <input type="text" style="width: 100%" name="datum[]" class="date change" value="{{- rz.datum|dt -}}">
                  {% else %}
                    <input type="hidden" name="rechnungszeile_id[]" value="{{- rz[''] -}}">
                    <input type="text" style="width: 100%" name="datum[]" class="date change" value="{{- rz['datum'] -}}">
                  {% endif %}
                  </td>

                  {% set artikelcode = rz.artikelcode %}
                  <td style="width: 20%">{% include 'rechnung/_select_for_artikel.html' %}</td>

                  {% if rz.id %}
                    <td style="width: 54%"><textarea style="width: 100%; height: 42px;" name="artikel[]" class="change">{{- rz.artikel -}}</textarea></td>
                    <td style="width: 10%"><textarea style="width: 100%; height: 42px;" name="betrag[]" class="change">{{- rz.betrag|sn -}}</textarea></td>
                    <td style="width: 6%">
                      <a class="zeile_loeschen" rechnungszeile_id="{{- rz.id -}}" href="#">Zeile löschen</a>
                    </td>
                  {% else %}
                    <td style="width: 54%"><textarea style="width: 100%; height: 42px;" name="artikel[]" class="change">{{- rz['artikel'] -}}</textarea></td>
                    <td style="width: 10%"><textarea style="width: 100%; height: 42px;" name="betrag[]" class="change">{{- rz['betrag'] -}}</textarea></td>
                    <td style="width: 6%">
                      <a class="zeile_loeschen" rechnungszeile_id="{{- rz['rechnungszeile_id'] -}}" href="#">Zeile löschen</a>
                    </td>
                  {% endif %}
                </tr>
              {% endfor %}
                <tr id="neue_zeile">
                  <td style="width: 10%">
                      <input type="hidden" name="rechnungszeile_id[]" value="">
                      <input type="text" style="width: 100%" name="datum[]" class="date" value="{{- datum -}}">
                  </td>
                  {% set artikelcode = 0 %}
                  <td style="width: 20%">{% include 'rechnung/_select_for_artikel.html' %}</td>
                  <td style="width: 54%"><textarea style="width: 100%; height: 42px;" name="artikel[]" class="change"></textarea></td>
                  <td style="width: 10%"><textarea style="width: 100%; height: 42px;" name="betrag[]" class="change"></textarea></td>
                  <td style="width: 6%"><a href="#" onclick="newrow($(this));">neue Zeile</a></td>
                </tr>
            </tbody>
        </table>
      </div>

      <div class="small-gap"></div>

      <div class="flex-container">
        <p><input class="btn" type="submit" value="Rechnung speichern"></p>

      {% if changed == False %}
        <p><a id="print" class="btn" href="#">Rechnung drucken</a></p>
      {% else %}
        <p><a id="print" class="btn grayed" href="#">Rechnung drucken</a></p>
      {% endif %}
      </div>
    </form>

    <script>
        function newrow($obj) {
            $obj.text("Zeile löschen");
            $obj.attr("onclick", "delete_newrow($(this));");
            $obj.closest("tr").removeAttr("id");

            var date = new Date();
            var year = String(date.getFullYear());
            var month = String(date.getMonth() + 1);
            if(month.length == 1){
                month = "0" + month;
            }
            var day = String(date.getDate());
                        if(day.length == 1){
                day = "0" + day;
            }
            $obj.closest("tbody").append(
              '<tr id="neue_zeile">' +
                '<input type="hidden" name="rechnungszeile_id[]" value="">' +
                '<td style="width: 10%">' + 
                    '<input type="text" style="width: 100%" name="datum[]" class="date" value="' + day + "." + month + "." + year + '">' + 
                '</td>' + 
                '<td style="width: 20%">' + 
                    '<select name="artikelcode[]">' +
                        '<option value="0" selected>&nbsp;</option>' +
                        '<option value="1">Visite</option>' +
                        '<option value="2">Labor</option>' +
                        '<option value="3">Injektion</option>' +
                        '<option value="4">Röntgen</option>' +
                        '<option value="5">Ultraschall</option>' +
                        '<option value="6">Medikamente</option>' +
                        '<option value="7">Futter und Medikamente</option>' +
                        '<option value="8">Artikel mit 20%</option>' +
                        '<option value="9">Artikel mit 13%</option>' +
                        '<option value="10">Artikel mit 10%</option>' +
                    '</select>' +
                '</td>' +
                '<td style="width: 54%">' + 
                    '<textarea style="width: 100%; height: 42px;" name="artikel[]" class="change"></textarea>' + 
                '</td>' + 
                '<td style="width: 10%">' +
                    '<textarea style="width: 100%; height: 42px;" name="betrag[]" class="change"></textarea>' + 
                '</td>' + 
                '<td style="width: 6%">' + 
                    '<a href="#" onclick="newrow($(this));">neue Zeile</a>' + 
                '</td>' +
              '</tr>'
            );
        }

        function delete_newrow($obj) {
            $obj.closest("tr").remove();
        };
        
        $(document).ready(function(){
            $.datepicker.setDefaults($.datepicker.regional["de"]);
            $('.date').datepicker({ 
                dateFormat: "dd.mm.yy",
                changeMonth: true,
                changeYear: true 
            });
            
            $('#new-artikelcode').focus();

            var element = document.getElementById("scroller");
            element.scrollTop = element.scrollHeight;

            $('.zeile_loeschen').click(function(){ 
                var rechnungszeile_id = $(this).attr("rechnungszeile_id");
                if(rechnungszeile_id != null){
                    if(confirm("Soll der Datensatz gelöscht werden?")){
                        window.location = "/rechnung/" + rechnungszeile_id.toString() + "/delete_rechnungszeile";
                        return true;
                    }
                    else{
                        return false;
                    }
                }
                return false; 
            });

            $('.change').on('input', function(){
              $('#print').addClass('grayed');
            });

            $('#print').click(function(){ 
              if($(this).hasClass('grayed') == false){
                var rechnung_id = $('#rechnung_id').val();
                window.location = "/rechnung/" + rechnung_id.toString() + "/download";
              }
              return false; 
            });

         });
    </script>
{% endblock %}
